#!/bin/bash

set -e

echo_colored() { echo -e "${2}$1\033[0m"; }
fail()         { echo_colored "$1" "\033[1;31m"; exit 1; }
echo_info()    { echo_colored "==> $1" "\033[1;36m"; }

check_env_variables() {
  [[ -n "$DOTFILES" ]] || fail 'The $DOTFILES env variable is not set'
}

create_directories() {
    echo_info "Creating a bunch of directories"
    mkdir -pv "$HOME/bin" "$HOME/tmp"
}

symlink_files() {
  echo_info "Symlinking all files ending in '.symlink'"
  local _files=$(find $DOTFILES -name '*.symlink')

  for abs_file in $_files; do
    local _symlinked=".$(basename ${abs_file%.symlink})"
    ln -sfv "$abs_file" "$HOME/$_symlinked"
  done
  echo
}

run_install_scripts() {
  for file in $(find $DOTFILES -name 'install.sh'); do
    echo_info "Running ${file#$DOTFILES/}"
    bash "$file"
  done
  echo
}

main() {
    check_env_variables
    create_directories
    symlink_files
    run_install_scripts
}

main "$@"
